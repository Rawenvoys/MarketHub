## 🛠️ Log Decyzji Architektonicznych (ADR)

| ADR ID | Tytuł | Status | Kontekst | Decyzja | Konsekwencje |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **ADR-001** | Konfiguracja Daty Początkowej Synchronizacji Historycznej | **Zaakceptowana** | Konieczność efektywnego skonfigurowania daty startowej dla pobierania historycznych kursów walut NBP. | Użycie **`appsettings.json`** z sekcją **`"NBP": { "InitialSyncDate": "YYYY-MM-DD" }`** i mapowanie na typ **`DateOnly`** (w kodzie .NET). | **[+]** Zgodność z konwencjami .NET. **[+]** Silne typowanie w kodzie. **[-]** Wymaga obsługi potencjalnego błędu parsowania daty. |
| **ADR-002** | Wybór Wersji Frameworka .NET | **Zaakceptowana** | Konieczność wyboru stabilnej wersji frameworka .NET, zgodnie z wymaganiem ("NET 8 lub wyższy"), z priorytetem na długoterminowe wsparcie. | Wybór **.NET 8** jako wersji **LTS (Long Term Support)**. | **[+]** Stabilność i 3 lata wsparcia. **[+]** Zgodność z najlepszymi praktykami dla systemów produkcyjnych. **[-]** Brak dostępu do ewentualnych drobnych usprawnień, które pojawią się w .NET 9 (wersja STS). |
| **ADR-003** | Implementacja Klienta API NBP | **Zaakceptowana** | Konieczność efektywnego i deklaratywnego pobierania danych z zewnętrznego API (NBP). | Użycie biblioteki **Refit** do generowania interfejsu **`INbpApi`** (klient HTTP). | **[+]** Znaczne uproszczenie kodu klienta HTTP (brak ręcznej implementacji `HttpClient`). **[+]** Łatwa integracja z DI w .NET 8. **[+]** Lepsza czytelność i utrzymanie. |
| **ADR-004** | Użycie Hangfire jako serwisu w tle (Daemon) zamiast Azure Functions CRON Triggered | **Zaakceptowana** | Konieczność wdrożenia dynamicznego harmonogramowania zadań cyklicznych na podstawie reguły CRON z bazy danych, minimalizując Vendor Lock-in. | Użycie **Hangfire** jako **wbudowanego serwisu w tle (Daemon)** wewnątrz `Rates.Api`. Użycie technicznego, krótkiego interwału CRON dla Hangfire, a **logika harmonogramowania domenowego** (np. "środa 16:00") realizowana przez `SourceSyncService` w Warstwie Aplikacji. | **[+]** Logika CRON przeniesiona do bazy danych (dynamiczna konfiguracja). **[+]** Uproszczone debugowanie lokalne. **[-]** Wymagane użycie bazy danych (np. SQL) jako magazynu dla Hangfire i tryb `Always On` dla serwisu API. |
| **ADR-005** | Przeniesienie Daty Początkowej Synchronizacji do IDataState | **Zaakceptowana** | Uznano, że konfiguracja daty początkowej synchronizacji historycznej (**ADR-001**) powinna znajdować się w dynamicznym magazynie danych, aby umożliwić jej łatwą zmianę per źródło w czasie działania systemu. | Zmiana pierwotnej decyzji (**ADR-001**): Pole **`InitialSyncDate`** zostaje usunięte z `appsettings.json` i przeniesione do kolumny **`NextSyncDate`** w polimorficznym obiekcie **`ISyncState`** (przechowywanym w Azure Cosmos). | **[+]** Konfiguracja jest przeniesiona do bazy danych i zarządzana per źródło (Dynamiczna konfiguracja). **[+]** `ISyncState` staje się kompletnym źródłem prawdy o procesie. **[-]** Wymaga logiki seedingowej, która ustawi początkową wartość `NextSyncDate` dla nowo tworzonych źródeł. |
| **ADR-006** | Polimorficzne Przechowywanie Stanu Synchronizacji (Source + IDataState) | **Zaakceptowana** | Konieczność przechowywania specyficznego stanu synchronizacji (np. `NextSyncDate` dla NBP vs. `NextLineNumber` dla plików) dla każdego źródła, gdzie każde źródło wymaga innej implementacji stanu. | Użycie bazy danych SQL do przechowywania **Agregatu `Source`** (konfiguracja), natomiast **Azure Cosmos** zostaje wybrane jako magazyn dla polimorficznej **Kolekcji `ISyncState`**. Każdy dokument `ISyncState` (np. `NbpSourceSyncState`, `FileSourceSyncState`) jest powiązany z `Source.Id` i zawiera stan specyficzny dla swojej Strategii, wykorzystując elastyczność schematu Azure Cosmos. | **[+]** Polimorfizm Stanu: Łatwe dodawanie nowych, niepowiązanych typów stanów bez zmiany głównego schematu SQL. **[+]** Separation of Concerns: Dane konfiguracji (SQL) oddzielone od danych operacyjnych (Azure Cosmos). **[-]** Dodatkowa złożoność infrastruktury (utrzymanie dwóch typów baz danych). |
| **ADR-007** | Konfiguracja Częstotliwości Wywołania Daemona Hangfire z AppSettings | **Zaakceptowana** | Konieczność centralnej kontroli nad częstotliwością, z jaką Hangfire wywołuje serwis orkiestracyjny (`SourceSyncService`), bez twardego kodowania interwału w `Program.cs`. | Harmonogram CRON dla **cyklicznego zadania Hangfire** zostanie zdefiniowany w **`appsettings.json`** (np. `"Hangfire:SourceSyncCronExpression": "*/5 * * * *"`) i odczytany podczas konfiguracji serwisu. Daemon wewnątrz siebie będzie iterował po wszystkich aktywnych `Source` i sprawdzał, czy ich **domenowy CRON** (z bazy danych) jest spełniony. | **[+]** Centralna kontrola nad częstotliwością skanowania. **[+]** Łatwa zmiana technicznego interwału w zależności od środowiska (np. co 1 min. w Dev, co 5 min. w Prod). **[+]** W pełni zachowana separacja między techniczną częstotliwością wywołania a logiczną regułą harmonogramowania. |