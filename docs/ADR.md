## ğŸ› ï¸ Log Decyzji Architektonicznych (ADR)

| ADR ID | TytuÅ‚ | Status | Kontekst | Decyzja | Konsekwencje |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **ADR-001** | Konfiguracja Daty PoczÄ…tkowej Synchronizacji Historycznej | **Zaakceptowana** | KoniecznoÅ›Ä‡ efektywnego skonfigurowania daty startowej dla pobierania historycznych kursÃ³w walut NBP. | UÅ¼ycie **`appsettings.json`** z sekcjÄ… **`"NBP": { "InitialSyncDate": "YYYY-MM-DD" }`** i mapowanie na typ **`DateOnly`** (w kodzie .NET). | **[+]** ZgodnoÅ›Ä‡ z konwencjami .NET. **[+]** Silne typowanie w kodzie. **[-]** Wymaga obsÅ‚ugi potencjalnego bÅ‚Ä™du parsowania daty. |
| **ADR-002** | WybÃ³r Wersji Frameworka .NET | **Zaakceptowana** | KoniecznoÅ›Ä‡ wyboru stabilnej wersji frameworka .NET, zgodnie z wymaganiem ("NET 8 lub wyÅ¼szy"), z priorytetem na dÅ‚ugoterminowe wsparcie. | WybÃ³r **.NET 8** jako wersji **LTS (Long Term Support)**. | **[+]** StabilnoÅ›Ä‡ i 3 lata wsparcia. **[+]** ZgodnoÅ›Ä‡ z najlepszymi praktykami dla systemÃ³w produkcyjnych. **[-]** Brak dostÄ™pu do ewentualnych drobnych usprawnieÅ„, ktÃ³re pojawiÄ… siÄ™ w .NET 9 (wersja STS). |
| **ADR-003** | Implementacja Klienta API NBP | **Zaakceptowana** | KoniecznoÅ›Ä‡ efektywnego i deklaratywnego pobierania danych z zewnÄ™trznego API (NBP). | UÅ¼ycie biblioteki **Refit** do generowania interfejsu **`INbpApi`** (klient HTTP). | **[+]** Znaczne uproszczenie kodu klienta HTTP (brak rÄ™cznej implementacji `HttpClient`). **[+]** Åatwa integracja z DI w .NET 8. **[+]** Lepsza czytelnoÅ›Ä‡ i utrzymanie. |
| **ADR-004** | UÅ¼ycie Hangfire jako serwisu w tle (Daemon) zamiast Azure Functions CRON Triggered | **Zaakceptowana** | KoniecznoÅ›Ä‡ wdroÅ¼enia dynamicznego harmonogramowania zadaÅ„ cyklicznych na podstawie reguÅ‚y CRON z bazy danych, minimalizujÄ…c Vendor Lock-in. | UÅ¼ycie **Hangfire** jako **wbudowanego serwisu w tle (Daemon)** wewnÄ…trz `Rates.Api`. UÅ¼ycie technicznego, krÃ³tkiego interwaÅ‚u CRON dla Hangfire, a **logika harmonogramowania domenowego** (np. "Å›roda 16:00") realizowana przez `SourceSyncService` w Warstwie Aplikacji. | **[+]** Logika CRON przeniesiona do bazy danych (dynamiczna konfiguracja). **[+]** Uproszczone debugowanie lokalne. **[-]** Wymagane uÅ¼ycie bazy danych (np. SQL) jako magazynu dla Hangfire i tryb `Always On` dla serwisu API. |
| **ADR-005** | Przeniesienie Daty PoczÄ…tkowej Synchronizacji do IDataState | **Zaakceptowana** | Uznano, Å¼e konfiguracja daty poczÄ…tkowej synchronizacji historycznej (**ADR-001**) powinna znajdowaÄ‡ siÄ™ w dynamicznym magazynie danych, aby umoÅ¼liwiÄ‡ jej Å‚atwÄ… zmianÄ™ per ÅºrÃ³dÅ‚o w czasie dziaÅ‚ania systemu. | Zmiana pierwotnej decyzji (**ADR-001**): Pole **`InitialSyncDate`** zostaje usuniÄ™te z `appsettings.json` i przeniesione do kolumny **`NextSyncDate`** w polimorficznym obiekcie **`ISyncState`** (przechowywanym w Azure Cosmos). | **[+]** Konfiguracja jest przeniesiona do bazy danych i zarzÄ…dzana per ÅºrÃ³dÅ‚o (Dynamiczna konfiguracja). **[+]** `ISyncState` staje siÄ™ kompletnym ÅºrÃ³dÅ‚em prawdy o procesie. **[-]** Wymaga logiki seedingowej, ktÃ³ra ustawi poczÄ…tkowÄ… wartoÅ›Ä‡ `NextSyncDate` dla nowo tworzonych ÅºrÃ³deÅ‚. |
| **ADR-006** | Polimorficzne Przechowywanie Stanu Synchronizacji (Source + IDataState) | **Zaakceptowana** | KoniecznoÅ›Ä‡ przechowywania specyficznego stanu synchronizacji (np. `NextSyncDate` dla NBP vs. `NextLineNumber` dla plikÃ³w) dla kaÅ¼dego ÅºrÃ³dÅ‚a, gdzie kaÅ¼de ÅºrÃ³dÅ‚o wymaga innej implementacji stanu. | UÅ¼ycie bazy danych SQL do przechowywania **Agregatu `Source`** (konfiguracja), natomiast **Azure Cosmos** zostaje wybrane jako magazyn dla polimorficznej **Kolekcji `ISyncState`**. KaÅ¼dy dokument `ISyncState` (np. `NbpSourceSyncState`, `FileSourceSyncState`) jest powiÄ…zany z `Source.Id` i zawiera stan specyficzny dla swojej Strategii, wykorzystujÄ…c elastycznoÅ›Ä‡ schematu Azure Cosmos. | **[+]** Polimorfizm Stanu: Åatwe dodawanie nowych, niepowiÄ…zanych typÃ³w stanÃ³w bez zmiany gÅ‚Ã³wnego schematu SQL. **[+]** Separation of Concerns: Dane konfiguracji (SQL) oddzielone od danych operacyjnych (Azure Cosmos). **[-]** Dodatkowa zÅ‚oÅ¼onoÅ›Ä‡ infrastruktury (utrzymanie dwÃ³ch typÃ³w baz danych). |
| **ADR-007** | Konfiguracja CzÄ™stotliwoÅ›ci WywoÅ‚ania Daemona Hangfire z AppSettings | **Zaakceptowana** | KoniecznoÅ›Ä‡ centralnej kontroli nad czÄ™stotliwoÅ›ciÄ…, z jakÄ… Hangfire wywoÅ‚uje serwis orkiestracyjny (`SourceSyncService`), bez twardego kodowania interwaÅ‚u w `Program.cs`. | Harmonogram CRON dla **cyklicznego zadania Hangfire** zostanie zdefiniowany w **`appsettings.json`** (np. `"Hangfire:SourceSyncCronExpression": "*/5 * * * *"`) i odczytany podczas konfiguracji serwisu. Daemon wewnÄ…trz siebie bÄ™dzie iterowaÅ‚ po wszystkich aktywnych `Source` i sprawdzaÅ‚, czy ich **domenowy CRON** (z bazy danych) jest speÅ‚niony. | **[+]** Centralna kontrola nad czÄ™stotliwoÅ›ciÄ… skanowania. **[+]** Åatwa zmiana technicznego interwaÅ‚u w zaleÅ¼noÅ›ci od Å›rodowiska (np. co 1 min. w Dev, co 5 min. w Prod). **[+]** W peÅ‚ni zachowana separacja miÄ™dzy technicznÄ… czÄ™stotliwoÅ›ciÄ… wywoÅ‚ania a logicznÄ… reguÅ‚Ä… harmonogramowania. |