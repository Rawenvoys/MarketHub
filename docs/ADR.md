## 🛠️ Log Decyzji Architektonicznych (ADR)

| ADR ID | Tytuł | Status | Kontekst | Decyzja | Konsekwencje |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **ADR-001** | Konfiguracja Daty Początkowej Synchronizacji Historycznej | **Zaakceptowana** | Konieczność efektywnego skonfigurowania daty startowej dla pobierania historycznych kursów walut NBP. | Użycie **`appsettings.json`** z sekcją **`"NBP": { "InitialSyncDate": "YYYY-MM-DD" }`** i mapowanie na typ **`DateOnly`** (w kodzie .NET). | **[+]** Zgodność z konwencjami .NET. **[+]** Silne typowanie w kodzie. **[-]** Wymaga obsługi potencjalnego błędu parsowania daty. |
| **ADR-002** | Wybór Wersji Frameworka .NET | **Zaakceptowana** | Konieczność wyboru stabilnej wersji frameworka .NET, zgodnie z wymaganiem ("NET 8 lub wyższy"), z priorytetem na długoterminowe wsparcie. | Wybór **.NET 8** jako wersji **LTS (Long Term Support)**. | **[+]** Stabilność i 3 lata wsparcia. **[+]** Zgodność z najlepszymi praktykami dla systemów produkcyjnych. **[-]** Brak dostępu do ewentualnych drobnych usprawnień, które pojawią się w .NET 9 (wersja STS). |
| **ADR-003** | Implementacja Klienta API NBP | **Zaakceptowana** | Konieczność efektywnego i deklaratywnego pobierania danych z zewnętrznego API (NBP). | Użycie biblioteki **Refit** do generowania interfejsu **`INbpApi`** (klient HTTP). | **[+]** Znaczne uproszczenie kodu klienta HTTP (brak ręcznej implementacji `HttpClient`). **[+]** Łatwa integracja z DI w .NET 8. **[+]** Lepsza czytelność i utrzymanie. |
| **ADR-004** | Użycie Hangfire jako serwisu w tle (Daemon) zamiast Azure Functions CRON Triggered | **Zaakceptowana** | Konieczność wdrożenia dynamicznego harmonogramowania zadań cyklicznych na podstawie reguły CRON z bazy danych, minimalizując Vendor Lock-in. | Użycie **Hangfire** jako **wbudowanego serwisu w tle (Daemon)** wewnątrz `Rates.Api`. Użycie technicznego, krótkiego interwału CRON dla Hangfire, a **logika harmonogramowania domenowego** (np. "środa 16:00") realizowana przez `RateSynchronizationDaemon` w Warstwie Aplikacji. | **[+]** Logika CRON przeniesiona do bazy danych (dynamiczna konfiguracja). **[+]** Uproszczone debugowanie lokalne. **[-]** Wymagane użycie bazy danych (np. SQL) jako magazynu dla Hangfire i tryb `Always On` dla serwisu API. |
| **ADR-005** | Przeniesienie Daty Początkowej Synchronizacji do IDataState | **Zaakceptowana** | Uznano, że konfiguracja daty początkowej synchronizacji historycznej (**ADR-001**) powinna znajdować się w dynamicznym magazynie danych, aby umożliwić jej łatwą zmianę per źródło w czasie działania systemu. | Zmiana pierwotnej decyzji (**ADR-001**): Pole **`InitialSyncDate`** zostaje usunięte z `appsettings.json` i przeniesione do kolumny **`SynchronizeFrom`** w polimorficznym obiekcie **`IDataState`** (przechowywanym w MongoDB). | **[+]** Konfiguracja jest przeniesiona do bazy danych i zarządzana per źródło (Dynamiczna konfiguracja). **[+]** `IDataState` staje się kompletnym źródłem prawdy o procesie. **[-]** Wymaga logiki seedingowej, która ustawi początkową wartość `SynchronizeFrom` dla nowo tworzonych źródeł. |
| **ADR-006** | Polimorficzne Przechowywanie Stanu Synchronizacji (Source + IDataState) | **Zaakceptowana** | Konieczność przechowywania specyficznego stanu synchronizacji (np. `NextSyncDate` dla NBP vs. `LastRowNumber` dla plików) dla każdego źródła, gdzie każde źródło wymaga innej implementacji stanu. | Użycie bazy danych SQL do przechowywania **Agregatu `TableSource`** (konfiguracja), natomiast **MongoDB** zostaje wybrane jako magazyn dla polimorficznej **Kolekcji `IDataState`**. Każdy dokument `IDataState` (np. `NbpDataState`, `FileDataState`) jest powiązany z `TableSource.Id` i zawiera stan specyficzny dla swojej Strategii, wykorzystując elastyczność schematu MongoDB. | **[+]** Polimorfizm Stanu: Łatwe dodawanie nowych, niepowiązanych typów stanów bez zmiany głównego schematu SQL. **[+]** Separation of Concerns: Dane konfiguracji (SQL) oddzielone od danych operacyjnych (MongoDB). **[-]** Dodatkowa złożoność infrastruktury (utrzymanie dwóch typów baz danych). |